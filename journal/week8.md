# Week 8 â€” Serverless Image Processing

## Introduction
This week we use CDK (Cloud Development Kit)(An Infrastructure as code tool) to create an S3 buckets, a Lambda functions and other items. This is to allow users to upload their avatars and update their profiles details.
## Create CDK stack
We first create a new folder in the project named thumbing-serverless-cdk. We will store all our CDK related files here.
Then we install the cdk using the code below.

```npm install aws-cdk -g  ```

we finally initialize the project with the code below. Our language of choice for the project will be Typescript

``` cdk init app --language typescript ```

The next step would be to bootstrap. Bootstraping involves deploying stacks with the AWS CDK and the required dedicated Amazon S3 Buckets and other containers to be available to AWS CloudFormation during the deployment

Run ``` cdk bootstrap "aws://${AWS_ACCOUNT_ID}/${AWS_DEFAULT_REGION}" ```

We can run the deploy command to check if the setup is correct

Run ```cdk deploy ```


### UseFul Commands for CDK
CDK Synth ``` cdk synth ```

The cdk synth command in AWS is a command-line tool that synthesizes a CDK app to CloudFormation template(s). It executes your CDK app, which causes the resources defined in it to be translated into an AWS CloudFormation template. The displayed output of cdk synth is a YAML-format template. The template is also saved in the cdk.out directory in JSON format.

CDK Deploy ``` cdk deploy ```

This deploys a CDK app to AWS. It uses the CloudFormation template that was generated by the cdk synth command to create or update AWS resources.

List Stack ``` cdk ls ```

This will lists the stacks in a CDK app

CDK Destroy ``` cdk destroy ```

Deletes a stack from AWS

 
## Create s3 bucket to store assets

We create an s3 bucket


## Serve assets Using Cloudfront
Cloud front is a CDN offered by AWS. It easily intergrates with S3 and other AWS services. We will manually create the Cloudfront distribution via the browser.

* Our origin domain will be our assets.Bytetech.digital S3 bucket. We leave the name as the default.

* Other we leave most of the option to the default selected apart from Redirect HTTP to HTTPS

* For the Response headers policy we set it to Simple CORS

* We add our alternate domain name. assets.bytetech.digital and its certificate

### Route53
We create a record for assets.bytetech.digital in our hosted zones linked to cloudfront

### Add cloudfront bucket policy to s3
We add the bucket policy by first copying and pasting the policy from cloudfront.

## Process images using a javascript lambda running sharpjs
Add the lambda folder /process-image to our aws/lambda
We add a lambda code using Javascript and the [sharpjs](https://sharp.pixelplumbing.com/install) image processing library
First install sharp using the code ``` npm i sharp ``` and the AWS SDK for JavaScript using ```npm i @aws-sdk/client-s3 ```

This is [Code](../aws/lambdas/process-images/index.js) to the lambda

## Implement lambda layers
## Use s3 event notifications to trigger processing images
## Implement HTTP API Gateway using a lambda authorizer
## Implement a ruby function to generate a resigned URL
## Upload assets to a bucket client side using a resigned URL
